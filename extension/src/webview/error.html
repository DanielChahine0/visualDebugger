<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Error Explanation ‚Äî Visual Debugger</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="config.js"></script>
</head>

<body>
    <div id="error-panel" class="ff-panel" role="main" aria-label="Error explanation">
        <!-- Skip link for keyboard/screen-reader users -->
        <a href="#section-quiz" class="sr-only sr-only--focusable">Skip to quiz</a>

        <!-- Screen-reader live region -->
        <div id="status-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

        <!-- ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ -->
        <div id="empty-state" class="ff-empty" role="status">
            <div class="ff-empty-icon" aria-hidden="true">üîç</div>
            <h1 class="ff-empty-heading">No errors detected yet</h1>
            <p class="ff-empty-body">Run your program and we'll<br />explain any errors that appear.</p>
        </div>

        <!-- ‚îÄ‚îÄ Content (hidden until data arrives) ‚îÄ‚îÄ -->
        <div id="error-content" style="display: none;">

            <!-- 1. Error Location -->
            <section class="ff-section ff-section--error" id="section-error" aria-labelledby="heading-error">
                <h2 id="heading-error" class="ff-heading">
                    <span class="ff-icon" aria-hidden="true">üö®</span>
                    <span id="category-badge" class="badge"></span>
                    <span class="text-muted text-sm" id="error-location"></span>
                </h2>
                <p id="error-message" class="ff-body" style="font-family: var(--vscode-editor-font-family, monospace); background-color: var(--vscode-textCodeBlock-background); padding: 8px; border-radius: 3px; word-break: break-word;"></p>
                <p class="ff-body text-muted text-sm" id="tldr-text" style="margin-top: 8px; font-weight: 600;"></p>
            </section>

            <!-- 2. What Happened -->
            <section class="ff-section ff-section--explanation" id="section-explanation" aria-labelledby="heading-explanation" style="display: none;">
                <h2 id="heading-explanation" class="ff-heading">
                    <span class="ff-icon" aria-hidden="true">üìñ</span>
                    What Happened
                </h2>
                <p class="ff-body" id="explanation-text"></p>
            </section>

            <!-- 3. How to Fix -->
            <section class="ff-section ff-section--fix" id="section-fix" aria-labelledby="heading-fix" style="display: none;">
                <h2 id="heading-fix" class="ff-heading">
                    <span class="ff-icon" aria-hidden="true">üîß</span>
                    How to Fix
                </h2>
                <div class="ff-body" id="fix-text"></div>
            </section>

            <!-- 4. How to Prevent (progressive disclosure) -->
            <section class="ff-section ff-section--prevent" id="section-prevent" aria-labelledby="heading-prevent" style="display: none;">
                <details class="ff-disclosure">
                    <summary class="ff-disclosure-trigger" id="heading-prevent">
                        <span class="ff-icon" aria-hidden="true">üõ°Ô∏è</span>
                        <span class="ff-disclosure-title">How to Prevent This</span>
                        <span class="ff-disclosure-hint" aria-hidden="true">Show tip</span>
                    </summary>
                    <div class="ff-disclosure-body">
                        <p class="ff-body" id="prevent-text"></p>
                    </div>
                </details>
            </section>

            <!-- 5. Best Practices (progressive disclosure) -->
            <section class="ff-section ff-section--practices" id="section-practices" aria-labelledby="heading-practices" style="display: none;">
                <details class="ff-disclosure">
                    <summary class="ff-disclosure-trigger" id="heading-practices">
                        <span class="ff-icon" aria-hidden="true">‚≠ê</span>
                        <span class="ff-disclosure-title">Best Practice</span>
                        <span class="ff-disclosure-hint" aria-hidden="true">Show details</span>
                    </summary>
                    <div class="ff-disclosure-body">
                        <p class="ff-body" id="practices-text"></p>
                    </div>
                </details>
            </section>

            <!-- 6. Suggested Prompt -->
            <section class="ff-section ff-section--prompt" id="section-prompt" aria-labelledby="heading-prompt" style="display: none;">
                <h2 id="heading-prompt" class="ff-heading">
                    <span class="ff-icon" aria-hidden="true">üí¨</span>
                    Try This Prompt Instead
                </h2>
                <p class="ff-body text-muted text-sm" style="margin-bottom: 8px;">Instead of "fix the bug," try a prompt like this:</p>
                <div class="prompt-block" id="prompt-text"></div>
                <button class="btn btn--secondary mt-8" id="copy-prompt-btn" style="width: 100%; min-height: 36px;" aria-label="Copy prompt to clipboard">Copy Prompt</button>
            </section>

            <!-- 7. Quiz -->
            <section class="ff-section ff-section--quiz" id="section-quiz" aria-labelledby="heading-quiz" style="display: none;">
                <h2 id="heading-quiz" class="ff-heading">
                    <span class="ff-icon" aria-hidden="true">üß™</span>
                    Test Yourself
                </h2>
                <p class="ff-body mb-8" id="quiz-question"></p>
                <div class="quiz-options" id="quiz-options" role="group" aria-label="Quiz answers"></div>
                <div class="quiz-feedback" id="quiz-feedback" style="display:none;" role="alert"></div>
            </section>

            <!-- TTS controls -->
            <div class="ff-tts-bar" id="tts-controls" style="display: none;" role="region" aria-label="Read aloud controls">
                <div class="ff-voice-group" role="radiogroup" aria-label="Voice">
                    <button class="ff-voice-btn active" id="voice-female" role="radio" aria-checked="true">Female voice</button>
                    <button class="ff-voice-btn" id="voice-male" role="radio" aria-checked="false">Male voice</button>
                </div>
                <button class="ff-btn--tts" id="tts-btn" aria-label="Read explanation aloud">üîä Read Aloud</button>
                <span class="ff-tts-status" id="tts-status" aria-live="polite"></span>
            </div>

        </div><!-- close #error-content -->
    </div>

    <script>
        // ‚îÄ‚îÄ State ‚îÄ‚îÄ
        let quizAnswered = false;
        let currentErrorData = null;
        let ttsAudio = null;
        let isSpeaking = false;
        let selectedVoice = 'female';

        // ‚îÄ‚îÄ VS Code API ‚îÄ‚îÄ
        let vscode;
        try {
            vscode = acquireVsCodeApi();
            window.vscode = vscode;
        } catch (e) {
            console.log("Browser preview mode (no VS Code API)");
        }

        // ‚îÄ‚îÄ Helpers (matching diff.html patterns) ‚îÄ‚îÄ
        function $(id) { return document.getElementById(id); }

        function announce(msg) {
            var el = $('status-live');
            if (el) el.textContent = msg;
        }

        function showSection(id, hasData) {
            var el = $(id);
            if (el) el.style.display = hasData ? '' : 'none';
        }

        function updateTtsStatus(text) {
            $('tts-status').textContent = text;
        }

        // ‚îÄ‚îÄ Helper: map quiz letter ("A"/"B"/"C"/"D") to 0-indexed number ‚îÄ‚îÄ
        function quizCorrectIndex(val) {
            if (typeof val === 'number') return val;
            var map = { A: 0, B: 1, C: 2, D: 3 };
            return map[val] ?? 0;
        }

        function cleanTextForTTS(html) {
            if (!html) return '';
            return html
                .replace(/<[^>]*>/g, '')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/\s+/g, ' ')
                .trim();
        }

        // ‚îÄ‚îÄ Disclosure hint toggle ‚îÄ‚îÄ
        document.querySelectorAll('.ff-disclosure').forEach(function (details) {
            details.addEventListener('toggle', function () {
                var hint = details.querySelector('.ff-disclosure-hint');
                if (!hint) return;
                var isPrevent = details.closest('#section-prevent');
                var showText = isPrevent ? 'Show tip' : 'Show details';
                var hideText = isPrevent ? 'Hide tip' : 'Hide details';
                hint.textContent = details.open ? hideText : showText;
            });
        });

        // ‚îÄ‚îÄ Main Update Function ‚îÄ‚îÄ
        function updatePanel(data) {
            currentErrorData = data;
            quizAnswered = false;

            // 1. Error Location & Badge
            var badge = $('category-badge');
            badge.textContent = data.category;
            badge.className = 'badge';
            badge.setAttribute('data-type', data.category.split(' ')[0]);

            var type = data.category.split(' ')[0];
            if (type === 'Syntax') { badge.style.color = 'var(--ff-syntax)'; badge.style.borderColor = 'var(--ff-syntax)'; }
            else if (type === 'Logic') { badge.style.color = 'var(--ff-logic)'; badge.style.borderColor = 'var(--ff-logic)'; }
            else if (type === 'Runtime') { badge.style.color = 'var(--ff-runtime)'; badge.style.borderColor = 'var(--ff-runtime)'; }

            $('error-location').textContent = data.location || (data.raw && data.raw.file + ':' + data.raw.line) || '';
            var errorMsg = data.errorMessage || (data.raw && data.raw.message) || '';
            $('error-message').textContent = errorMsg;

            // TL;DR
            var tldr = $('tldr-text');
            if (data.tldr) {
                tldr.textContent = data.tldr;
                tldr.style.display = '';
            } else {
                tldr.style.display = 'none';
            }

            // 2. What Happened
            var hasExplanation = !!data.explanation;
            showSection('section-explanation', hasExplanation);
            if (hasExplanation) $('explanation-text').innerHTML = data.explanation;

            // 3. How to Fix
            var hasFixData = !!(data.howToFix && (Array.isArray(data.howToFix) ? data.howToFix.length > 0 : data.howToFix));
            showSection('section-fix', hasFixData);
            if (hasFixData) {
                if (Array.isArray(data.howToFix)) {
                    var fixList = data.howToFix.map(function (step) { return '<li>' + step + '</li>'; }).join('');
                    $('fix-text').innerHTML = '<ol style="padding-left: 18px; margin: 0;">' + fixList + '</ol>';
                } else {
                    $('fix-text').innerHTML = data.howToFix;
                }
            }

            // 4. How to Prevent
            var hasPrevent = !!data.howToPrevent;
            showSection('section-prevent', hasPrevent);
            if (hasPrevent) $('prevent-text').innerHTML = data.howToPrevent;

            // 5. Best Practices
            var hasPractices = !!data.bestPractices;
            showSection('section-practices', hasPractices);
            if (hasPractices) $('practices-text').innerHTML = data.bestPractices;

            // 6. Suggested Prompt
            var hasPrompt = !!data.suggestedPrompt;
            showSection('section-prompt', hasPrompt);
            if (hasPrompt) $('prompt-text').textContent = data.suggestedPrompt;

            // 7. Quiz
            var hasQuiz = !!data.quiz;
            showSection('section-quiz', hasQuiz);
            if (hasQuiz) {
                var correctIdx = quizCorrectIndex(data.quiz.correct);
                $('quiz-question').innerHTML = data.quiz.question;
                var quizOptions = $('quiz-options');
                quizOptions.innerHTML = '';
                $('quiz-feedback').style.display = 'none';

                data.quiz.options.forEach(function (option, index) {
                    var optionEl = document.createElement('div');
                    optionEl.className = 'quiz-option';
                    optionEl.textContent = option;
                    optionEl.style.animationDelay = (index * 0.05) + 's';
                    optionEl.style.minHeight = '36px';
                    optionEl.classList.add('slide-in');

                    optionEl.addEventListener('click', function () {
                        if (quizAnswered) return;
                        quizAnswered = true;

                        document.querySelectorAll('.quiz-option').forEach(function (el, i) {
                            el.setAttribute('data-answered', 'true');
                            el.style.cursor = 'default';
                            if (i === correctIdx) {
                                el.classList.add('correct');
                            } else if (i === index && i !== correctIdx) {
                                el.classList.add('incorrect');
                            } else {
                                el.style.opacity = '0.6';
                            }
                        });

                        var isCorrect = index === correctIdx;
                        var fb = $('quiz-feedback');
                        fb.textContent = isCorrect
                            ? 'Correct! ' + data.quiz.explanation
                            : 'Not quite. ' + data.quiz.explanation;
                        fb.style.display = 'block';
                        fb.className = 'quiz-feedback';
                        if (isCorrect) fb.style.borderLeftColor = 'var(--ff-success)';
                        else fb.style.borderLeftColor = 'var(--ff-runtime)';

                        if (window.vscode) {
                            window.vscode.postMessage({ type: 'quizAnswer', correct: isCorrect });
                        }
                    });
                    quizOptions.appendChild(optionEl);
                });
            }

            // Show content, hide empty state
            $('empty-state').style.display = 'none';
            $('error-content').style.display = 'block';
            $('tts-controls').style.display = '';
            updateTtsStatus('');

            announce('Error explanation updated.');
        }

        // ‚îÄ‚îÄ Listen for messages from extension host ‚îÄ‚îÄ
        window.addEventListener('message', function (event) {
            var msg = event.data;

            if (msg.type === 'showError') {
                updatePanel(msg.data);

            } else if (msg.type === 'playAudio') {
                stopAudio();
                var audio = new Audio('data:' + msg.data.mimeType + ';base64,' + msg.data.base64Audio);
                ttsAudio = audio;
                isSpeaking = true;
                $('tts-btn').textContent = '‚èπÔ∏è Stop';
                $('tts-btn').classList.add('ff-btn--playing');
                updateTtsStatus('Playing...');
                audio.onended = function () {
                    ttsAudio = null; isSpeaking = false;
                    $('tts-btn').textContent = 'üîä Read Aloud';
                    $('tts-btn').classList.remove('ff-btn--playing');
                    updateTtsStatus('');
                    announce('Audio finished.');
                };
                audio.onerror = function () {
                    ttsAudio = null; isSpeaking = false;
                    $('tts-btn').textContent = 'üîä Read Aloud';
                    $('tts-btn').classList.remove('ff-btn--playing');
                    updateTtsStatus('');
                    announce('Audio playback failed.');
                };
                audio.play().catch(function () {
                    ttsAudio = null; isSpeaking = false;
                    $('tts-btn').textContent = 'üîä Read Aloud';
                    updateTtsStatus('');
                    announce('Could not play audio.');
                });

            } else if (msg.type === 'ttsError') {
                announce(msg.data.message);
                updateTtsStatus('Using browser voice...');
                speakWithWebSpeech(getReadableText());

            } else if (msg.type === 'clear') {
                stopAudio();
                $('empty-state').style.display = '';
                $('error-content').style.display = 'none';
            }
        });

        // ‚îÄ‚îÄ TTS helpers ‚îÄ‚îÄ
        function getReadableText() {
            if (!currentErrorData) return '';
            var data = currentErrorData;
            var fixText = Array.isArray(data.howToFix) ? data.howToFix.join('. ') : (data.howToFix || '');
            return cleanTextForTTS([
                data.explanation,
                'Here is how to fix it. ' + fixText,
                'To prevent this in the future: ' + (data.howToPrevent || ''),
            ].join('. '));
        }

        function stopAudio() {
            if (ttsAudio) { ttsAudio.pause(); ttsAudio = null; }
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            isSpeaking = false;
            updateTtsStatus('');
        }

        function speakWithWebSpeech(text) {
            if (!('speechSynthesis' in window) || !text) {
                announce('Text-to-speech is not available.');
                updateTtsStatus('');
                return;
            }
            var u = new SpeechSynthesisUtterance(text);
            u.rate = 0.95;
            isSpeaking = true;
            $('tts-btn').textContent = '‚èπÔ∏è Stop';
            $('tts-btn').classList.add('ff-btn--playing');
            updateTtsStatus('Playing...');
            u.onend = function () {
                isSpeaking = false;
                $('tts-btn').textContent = 'üîä Read Aloud';
                $('tts-btn').classList.remove('ff-btn--playing');
                updateTtsStatus('');
            };
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
        }

        // ‚îÄ‚îÄ Voice toggle ‚îÄ‚îÄ
        $('voice-female').addEventListener('click', function () {
            selectedVoice = 'female';
            $('voice-female').classList.add('active');
            $('voice-female').setAttribute('aria-checked', 'true');
            $('voice-male').classList.remove('active');
            $('voice-male').setAttribute('aria-checked', 'false');
        });

        $('voice-male').addEventListener('click', function () {
            selectedVoice = 'male';
            $('voice-male').classList.add('active');
            $('voice-male').setAttribute('aria-checked', 'true');
            $('voice-female').classList.remove('active');
            $('voice-female').setAttribute('aria-checked', 'false');
        });

        // ‚îÄ‚îÄ TTS button ‚îÄ‚îÄ
        $('tts-btn').addEventListener('click', function () {
            if (isSpeaking) {
                stopAudio();
                $('tts-btn').textContent = 'üîä Read Aloud';
                $('tts-btn').classList.remove('ff-btn--playing');
                updateTtsStatus('');
                return;
            }
            var text = getReadableText();
            if (!text) { announce('No explanation to read yet.'); return; }

            if (vscode) {
                vscode.postMessage({ type: 'requestTts', text: text });
                $('tts-btn').textContent = '‚è≥ Loading...';
                updateTtsStatus('Loading...');
            } else {
                speakWithWebSpeech(text);
            }
        });

        // ‚îÄ‚îÄ Copy Prompt Button ‚îÄ‚îÄ
        $('copy-prompt-btn').addEventListener('click', async function () {
            var promptText = $('prompt-text').textContent;
            try {
                await navigator.clipboard.writeText(promptText);
                $('copy-prompt-btn').textContent = 'Copied!';
                $('copy-prompt-btn').classList.add('btn--success');
                setTimeout(function () {
                    $('copy-prompt-btn').textContent = 'Copy Prompt';
                    $('copy-prompt-btn').classList.remove('btn--success');
                }, 2000);
            } catch (e) {
                // Fallback for webview where clipboard API may not work
                var textArea = document.createElement('textarea');
                textArea.value = promptText;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                $('copy-prompt-btn').textContent = 'Copied!';
                $('copy-prompt-btn').classList.add('btn--success');
                setTimeout(function () {
                    $('copy-prompt-btn').textContent = 'Copy Prompt';
                    $('copy-prompt-btn').classList.remove('btn--success');
                }, 2000);
            }
        });

        // ‚îÄ‚îÄ Initialization (Mock Data for Preview) ‚îÄ‚îÄ
        var MOCK_ERROR_DATA = {
            category: "Runtime Error",
            location: "App.tsx, line 15",
            errorMessage: "TypeError: Cannot read properties of undefined (reading 'map')",
            tldr: "You called .map() on undefined ‚Äî initialize your state with [].",
            explanation: "You're trying to call .map() on a variable called 'data', but 'data' is undefined. This means the variable hasn't been assigned a value yet ‚Äî likely because an API call hasn't finished loading when the component tries to render.",
            howToFix: [
                "Go to line 15 in App.tsx",
                "Initialize your state with an empty array: const [data, setData] = useState([])",
                "Or add a guard before .map(): data?.map(...)"
            ],
            howToPrevent: "Always initialize state variables with a sensible default value. If a variable will hold an array, initialize it as []. This prevents undefined errors when your component renders before async data arrives.",
            bestPractices: "Use optional chaining (data?.map()) and nullish coalescing (data ?? []) as defensive programming patterns. These are industry-standard approaches to safely handle values that might be null or undefined.",
            suggestedPrompt: "Fix the TypeError in App.tsx at line 15 where data.map() fails because useState() has no initial value.\n\nContext:\n- data is used with .map() to render a list of items\n- useState() returns undefined by default when no argument is passed\n- .map() is an array method ‚Äî it throws when called on undefined\n\nWhat to fix:\n- Add [] as the initial value: useState([])\n- Add a guard check before calling .map() to handle loading states\n\nExplain:\n- Why undefined causes this specific TypeError\n- What initial values prevent this class of bug\n- How to verify the fix works after applying it",
            quiz: {
                question: "Why does calling .map() on 'data' throw a TypeError in this case?",
                options: [
                    "A) .map() is not a valid JavaScript method",
                    "B) 'data' is undefined because the state wasn't initialized with a default value",
                    "C) The API returned an error",
                    "D) .map() only works on strings, not arrays"
                ],
                correct: 1,
                explanation: "Correct! The state variable 'data' was not given a default value (like []), so it starts as undefined. When React tries to render before the API data arrives, it calls .map() on undefined, which crashes."
            }
        };

        if (!vscode) {
            updatePanel(MOCK_ERROR_DATA);
        } else {
            vscode.postMessage({ type: 'ready' });
        }
    </script>
</body>
</html>
