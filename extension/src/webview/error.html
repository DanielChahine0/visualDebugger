<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Error Explanation ‚Äî Visual Debugger</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="config.js"></script>
</head>

<body>
    <div id="error-panel">
        <!-- Header with category badge -->
        <div class="card-header">
            <h1>üîç Error Explanation</h1>
        </div>

        <!-- Empty state ‚Äî shown before any error is detected -->
        <div id="empty-state" class="card" style="text-align: center; padding: 32px 16px; opacity: 0.7;">
            <p style="font-size: 1.1em; margin-bottom: 8px;">No errors detected yet.</p>
            <p class="text-muted text-sm">Run your program and Visual Debugger will automatically explain any errors that appear.</p>
        </div>

        <!-- Error content ‚Äî hidden until an error is received -->
        <div id="error-content" style="display: none;">

        <!-- Error Location Card -->
        <div class="card slide-in" id="location-card">
            <div class="card-header">
                <span class="badge" id="category-badge"></span>
                <span class="text-muted text-sm" id="error-location"></span>
            </div>
            <p id="error-message"
                style="font-family: var(--vscode-editor-font-family, monospace); background: var(--vscode-textCodeBlock-background, rgba(127,127,127,0.1)); padding: 10px 14px; border-radius: 4px; font-size: 0.92em;">
            </p>
        </div>

        <!-- What Happened -->
        <div class="card slide-in" id="explanation-card">
            <div class="section">
                <div class="section-title"><span class="icon">üí°</span> What Happened</div>
                <div class="section-content" id="explanation-text"></div>
            </div>
        </div>

        <!-- How to Fix -->
        <div class="card slide-in" id="fix-card">
            <div class="section">
                <div class="section-title"><span class="icon">üîß</span> How to Fix</div>
                <div class="section-content" id="fix-text"></div>
            </div>
        </div>

        <!-- How to Prevent -->
        <div class="card slide-in" id="prevent-card">
            <div class="section">
                <div class="section-title"><span class="icon">üõ°Ô∏è</span> How to Prevent</div>
                <div class="section-content" id="prevent-text"></div>
            </div>
        </div>

        <!-- Best Practices -->
        <div class="card slide-in" id="practices-card">
            <div class="section">
                <div class="section-title"><span class="icon">‚≠ê</span> Best Practices</div>
                <div class="section-content" id="practices-text"></div>
            </div>
        </div>

        <!-- Quiz Section -->
        <div class="card slide-in" id="quiz-card">
            <div class="section">
                <div class="section-title"><span class="icon">üß†</span> Test Yourself</div>
                <p class="mb-8" id="quiz-question"></p>
                <div class="quiz-options" id="quiz-options">
                    <!-- Options rendered by JS -->
                </div>
                <div class="quiz-feedback" id="quiz-feedback" style="display:none;"></div>
            </div>
        </div>

        </div><!-- close #error-content -->

        <!-- TTS Controls -->
        <div class="mt-12" id="tts-controls" style="display: none; align-items: center; gap: 10px; flex-wrap: wrap;">
            <div
                style="display: flex; border-radius: 6px; overflow: hidden; border: 1px solid var(--vscode-input-border, rgba(127,127,127,0.25));">
                <button class="btn voice-toggle active" id="voice-female"
                    style="border-radius: 0; border: none; padding: 6px 12px; font-size: 0.88em;">üë© Female</button>
                <button class="btn voice-toggle" id="voice-male"
                    style="border-radius: 0; border: none; border-left: 1px solid var(--vscode-input-border, rgba(127,127,127,0.25)); padding: 6px 12px; font-size: 0.88em;">üë®
                    Male</button>
            </div>
            <button class="btn btn--secondary" id="tts-btn">üîä Read Aloud</button>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ State ‚îÄ‚îÄ
        let quizAnswered = false;
        let currentErrorData = null;

        // ‚îÄ‚îÄ Helper: map quiz letter ("A"/"B"/"C"/"D") to 0-indexed number ‚îÄ‚îÄ
        function quizCorrectIndex(val) {
            if (typeof val === 'number') return val;
            const map = { A: 0, B: 1, C: 2, D: 3 };
            return map[val] ?? 0;
        }

        // ‚îÄ‚îÄ Main Update Function ‚îÄ‚îÄ
        function updatePanel(data) {
            currentErrorData = data;
            quizAnswered = false;

            // 1. Header & Location
            document.getElementById('category-badge').textContent = data.category;
            document.getElementById('category-badge').className = 'badge badge--' + data.category.toLowerCase().replace(/\s+/g, '-');
            document.getElementById('error-location').textContent = data.location || (data.raw && data.raw.file + ':' + data.raw.line) || '';
            // errorMessage may be top-level (mock) or nested under raw (real Gemini data)
            const errorMsg = data.errorMessage || (data.raw && data.raw.message) || '';
            document.getElementById('error-message').textContent = errorMsg;

            // 2. Content Sections
            document.getElementById('explanation-text').innerHTML = data.explanation;

            // howToFix: may be an array (mock) or a string (Gemini)
            const howToFix = data.howToFix;
            if (Array.isArray(howToFix)) {
                const fixList = howToFix.map(step => `<li>${step}</li>`).join('');
                document.getElementById('fix-text').innerHTML = `<ol style="padding-left: 18px; margin: 0;">${fixList}</ol>`;
            } else {
                document.getElementById('fix-text').innerHTML = howToFix || '';
            }

            document.getElementById('prevent-text').innerHTML = data.howToPrevent || '';
            document.getElementById('practices-text').innerHTML = data.bestPractices || '';

            // 3. Quiz
            const quizCard = document.getElementById('quiz-card');
            if (data.quiz) {
                const correctIdx = quizCorrectIndex(data.quiz.correct);
                quizCard.style.display = 'block';
                document.getElementById('quiz-question').innerHTML = data.quiz.question;
                const quizOptions = document.getElementById('quiz-options');
                quizOptions.innerHTML = '';
                document.getElementById('quiz-feedback').style.display = 'none';

                data.quiz.options.forEach((option, index) => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'quiz-option';
                    optionEl.textContent = option;
                    optionEl.style.animationDelay = (index * 0.06) + 's';
                    optionEl.addEventListener('click', () => {
                        if (quizAnswered) return;
                        quizAnswered = true;

                        document.querySelectorAll('.quiz-option').forEach((el, i) => {
                            el.setAttribute('data-answered', 'true');
                            el.style.pointerEvents = 'none';
                            if (i === correctIdx) {
                                el.classList.add('correct');
                            } else if (i === index && i !== correctIdx) {
                                el.classList.add('incorrect');
                            } else {
                                el.style.opacity = '0.5';
                            }
                        });

                        const isCorrect = index === correctIdx;
                        const fb = document.getElementById('quiz-feedback');
                        fb.className = 'quiz-feedback ' + (isCorrect ? 'correct' : 'incorrect');
                        fb.textContent = isCorrect
                            ? '‚úÖ ' + data.quiz.explanation
                            : '‚ùå Not quite. ' + data.quiz.explanation;
                        fb.style.display = 'block';

                        if (window.vscode) {
                            window.vscode.postMessage({ type: 'quizAnswer', correct: isCorrect });
                        }
                    });
                    quizOptions.appendChild(optionEl);
                });
            } else {
                quizCard.style.display = 'none';
            }

            // Show content, hide empty state
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('error-content').style.display = 'block';
            document.getElementById('tts-controls').style.display = 'flex';
        }

        // ‚îÄ‚îÄ VS Code Integration ‚îÄ‚îÄ
        let vscode;
        try {
            vscode = acquireVsCodeApi();
            window.vscode = vscode;
        } catch (e) {
            console.log("Browser preview mode (no VS Code API)");
        }

        // Listen for messages from extension
        window.addEventListener('message', (event) => {
            const { type, data } = event.data; // Extension sends { type: 'showError', data: {...} }
            if (type === 'showError') {
                updatePanel(data);
            }
        });

        // ‚îÄ‚îÄ Initialization ‚îÄ‚îÄ
        const MOCK_ERROR_DATA = {
            category: "Runtime Error",
            location: "App.tsx, line 15",
            errorMessage: "TypeError: Cannot read properties of undefined (reading 'map')",
            explanation: "You're trying to call .map() on a variable called 'data', but 'data' is undefined. This means the variable hasn't been assigned a value yet ‚Äî likely because an API call hasn't finished loading when the component tries to render.",
            howToFix: [
                "Go to line 15 in App.tsx",
                "Initialize your state with an empty array: const [data, setData] = useState([])",
                "Or add a guard before .map(): data?.map(...)"
            ],
            howToPrevent: "Always initialize state variables with a sensible default value. If a variable will hold an array, initialize it as []. This prevents undefined errors when your component renders before async data arrives.",
            bestPractices: "Use optional chaining (data?.map()) and nullish coalescing (data ?? []) as defensive programming patterns. These are industry-standard approaches to safely handle values that might be null or undefined.",
            quiz: {
                question: "Why does calling .map() on 'data' throw a TypeError in this case?",
                options: [
                    "A) .map() is not a valid JavaScript method",
                    "B) 'data' is undefined because the state wasn't initialized with a default value",
                    "C) The API returned an error",
                    "D) .map() only works on strings, not arrays"
                ],
                correct: 1, // B (0-indexed)
                explanation: "Correct! The state variable 'data' was not given a default value (like []), so it starts as undefined. When React tries to render before the API data arrives, it calls .map() on undefined, which crashes."
            }
        };

        // If in browser (no vscode), load mock data immediately for preview
        if (!vscode) {
            updatePanel(MOCK_ERROR_DATA);
        } else {
            // Signal that the webview is ready to receive messages
            vscode.postMessage({ type: 'ready' });
        }

        // ‚îÄ‚îÄ ElevenLabs TTS ‚Äî Fine-Tuned Natural Voice ‚îÄ‚îÄ
        // Premium voices: Sarah (soft, natural female), Chris (casual, conversational male)
        const VOICES = {
            female: { id: 'EXAVITQu4vr4xnSDxMaL', name: 'Sarah' },
            male: { id: 'iP95p4xoKVk53GoZ742B', name: 'Chris' }
        };
        let selectedVoice = 'female';
        
        // Voice toggle buttons
        const voiceFemaleBtn = document.getElementById('voice-female');
        const voiceMaleBtn = document.getElementById('voice-male');
        
        voiceFemaleBtn.addEventListener('click', () => {
            selectedVoice = 'female';
            voiceFemaleBtn.classList.add('active');
            voiceMaleBtn.classList.remove('active');
        });
        voiceMaleBtn.addEventListener('click', () => {
            selectedVoice = 'male';
            voiceMaleBtn.classList.add('active');
            voiceFemaleBtn.classList.remove('active');
        });

        // Strip HTML tags and clean text for natural TTS reading
        function cleanTextForTTS(html) {
            if (!html) return '';
            return html
                .replace(/<code>/g, '')
                .replace(/<\/code>/g, '')
                .replace(/<strong>/g, '')
                .replace(/<\/strong>/g, '')
                .replace(/<em>/g, '')
                .replace(/<\/em>/g, '')
                .replace(/<[^>]*>/g, '')    // strip remaining tags
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/\s+/g, ' ')       // normalize whitespace
                .trim();
        }

        const ttsBtn = document.getElementById('tts-btn');
        let ttsAudio = null;
        let isSpeaking = false;

        ttsBtn.addEventListener('click', async () => {
            // Toggle off if already speaking
            if (isSpeaking && ttsAudio) {
                ttsAudio.pause();
                ttsAudio = null;
                isSpeaking = false;
                ttsBtn.textContent = 'üîä Read Aloud';
                ttsBtn.classList.remove('btn--tts-playing');
                return;
            }

            // Gather and clean explanation text
            const data = currentErrorData || MOCK_ERROR_DATA;
            const fixText = Array.isArray(data.howToFix) ? data.howToFix.join('. ') : (data.howToFix || '');
            const textToRead = cleanTextForTTS([
                data.explanation,
                'Here is how to fix it. ' + fixText,
                'To prevent this in the future: ' + (data.howToPrevent || ''),
            ].join('. '));

            // Use API key from config.js, fall back to browser speech
            const apiKey = (typeof ELEVENLABS_API_KEY !== 'undefined' && ELEVENLABS_API_KEY !== 'your_api_key_here')
                ? ELEVENLABS_API_KEY : null;

            ttsBtn.textContent = '‚è≥ Loading...';
            ttsBtn.classList.add('btn--tts-loading');

            if (apiKey) {
                try {
                    const voice = VOICES[selectedVoice];
                    const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'xi-api-key': apiKey },
                        body: JSON.stringify({
                            text: textToRead,
                            model_id: 'eleven_turbo_v2_5',
                            voice_settings: {
                                stability: 0.50,
                                similarity_boost: 0.65,
                                style: 0.10,
                                use_speaker_boost: true
                            }
                        })
                    });
                    if (!res.ok) {
                        const errorBody = await res.text().catch(() => '');
                        throw new Error(`API ${res.status}: ${errorBody.slice(0, 100)}`);
                    }
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    ttsAudio = new Audio(url);
                    isSpeaking = true;
                    ttsBtn.textContent = '‚èπÔ∏è Stop';
                    ttsBtn.classList.remove('btn--tts-loading');
                    ttsBtn.classList.add('btn--tts-playing');
                    ttsAudio.onended = () => {
                        isSpeaking = false;
                        ttsBtn.textContent = 'üîä Read Aloud';
                        ttsBtn.classList.remove('btn--tts-playing');
                        URL.revokeObjectURL(url);
                    };
                    ttsAudio.onerror = () => {
                        isSpeaking = false;
                        ttsBtn.textContent = '‚ùå Audio Error';
                        ttsBtn.classList.remove('btn--tts-playing');
                        setTimeout(() => { ttsBtn.textContent = 'üîä Read Aloud'; }, 3000);
                    };
                    ttsAudio.play();
                    return;
                } catch (e) {
                    console.warn('ElevenLabs TTS error:', e);
                    ttsBtn.textContent = '‚ùå ' + (e.message || 'TTS Failed');
                    ttsBtn.classList.remove('btn--tts-loading');
                    setTimeout(() => { ttsBtn.textContent = 'üîä Read Aloud'; }, 3000);
                    // Fall through to browser TTS
                }
            }

            // Fallback: browser SpeechSynthesis
            ttsBtn.classList.remove('btn--tts-loading');
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(textToRead);
                utterance.rate = 0.95;
                utterance.pitch = 1.0;
                isSpeaking = true;
                ttsBtn.textContent = '‚èπÔ∏è Stop';
                ttsBtn.classList.add('btn--tts-playing');
                utterance.onend = () => { isSpeaking = false; ttsBtn.textContent = 'üîä Read Aloud'; ttsBtn.classList.remove('btn--tts-playing'); };
                speechSynthesis.speak(utterance);
            } else {
                ttsBtn.textContent = '‚ùå TTS Unavailable';
                setTimeout(() => { ttsBtn.textContent = 'üîä Read Aloud'; }, 3000);
            }
        });
    </script>
</body>

</html>