<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fix Review ‚Äî FlowFixer</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="config.js"></script>
</head>

<body>
    <div id="diff-panel" class="ff-panel" role="main" aria-label="Fix explanation">
        <!-- Skip link for keyboard/screen-reader users -->
        <a href="#section-todo" class="sr-only sr-only--focusable">Skip to action items</a>

        <!-- Screen-reader live region -->
        <div id="status-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

        <!-- ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ -->
        <div id="empty-state" class="ff-empty" role="status">
            <div class="ff-empty-icon" aria-hidden="true">üîß</div>
            <h1 class="ff-empty-heading">Waiting for your first fix</h1>
            <p class="ff-empty-body">
                Fix a bug in your code.<br />
                We'll explain what changed and why.
            </p>
        </div>

        <!-- ‚îÄ‚îÄ Content (hidden until data arrives) ‚îÄ‚îÄ -->
        <div id="diff-content" style="display: none;">

            <!-- File context -->
            <div class="ff-file-bar" id="file-bar" style="display: none;" aria-label="File changed">
                <span class="ff-file-icon" aria-hidden="true">üìÑ</span>
                <span class="ff-file-name" id="diff-file"></span>
            </div>

            <!-- 1. Quick Summary -->
            <section class="ff-section ff-section--summary" id="section-summary"
                aria-labelledby="heading-summary" style="display: none;">
                <h2 id="heading-summary" class="ff-heading">
                    <span class="ff-icon" aria-hidden="true">üìù</span>
                    Quick Summary
                </h2>
                <p class="ff-body" id="quick-summary"></p>
            </section>

            <!-- 2. Why This Fixes It (progressive disclosure) -->
            <section class="ff-section ff-section--why" id="section-why"
                aria-labelledby="heading-why" style="display: none;">
                <details class="ff-disclosure">
                    <summary class="ff-disclosure-trigger" id="heading-why">
                        <span class="ff-icon" aria-hidden="true">üí°</span>
                        <span class="ff-disclosure-title">Why This Fixes It</span>
                        <span class="ff-disclosure-hint" aria-hidden="true">Show details</span>
                    </summary>
                    <div class="ff-disclosure-body">
                        <p class="ff-body" id="why-it-works"></p>
                    </div>
                </details>
            </section>

            <!-- 3. What To Do Next (sticky card) -->
            <section class="ff-section ff-section--todo" id="section-todo"
                aria-labelledby="heading-todo" style="display: none;">
                <h2 id="heading-todo" class="ff-heading">
                    <span class="ff-icon" aria-hidden="true">‚úÖ</span>
                    What To Do Next
                </h2>
                <ul class="ff-checklist" id="what-to-do-next" role="list"
                    aria-label="Steps to check the fix"></ul>
                <p class="ff-check-done" id="check-done" style="display: none;" aria-live="polite">
                    All done ‚Äî nice work!
                </p>
            </section>

            <!-- 4. Key Takeaway -->
            <section class="ff-section ff-section--takeaway" id="section-takeaway"
                aria-labelledby="heading-takeaway" style="display: none;">
                <h2 id="heading-takeaway" class="ff-heading">
                    <span class="ff-icon" aria-hidden="true">üß†</span>
                    Key Takeaway
                </h2>
                <blockquote class="ff-callout" id="key-takeaway"></blockquote>
            </section>

            <!-- 5. Think About It (progressive disclosure) -->
            <section class="ff-section ff-section--question" id="section-question"
                aria-labelledby="heading-question" style="display: none;">
                <details class="ff-disclosure">
                    <summary class="ff-disclosure-trigger" id="heading-question">
                        <span class="ff-icon" aria-hidden="true">ü§î</span>
                        <span class="ff-disclosure-title">Think About It</span>
                        <span class="ff-disclosure-hint" aria-hidden="true">Show question</span>
                    </summary>
                    <div class="ff-disclosure-body">
                        <p class="ff-question" id="check-question"></p>
                    </div>
                </details>
            </section>

            <!-- TTS controls -->
            <div class="ff-tts-bar" id="tts-controls" style="display: none;" role="region" aria-label="Read aloud controls">
                <div class="ff-voice-group" role="radiogroup" aria-label="Voice">
                    <button class="ff-voice-btn active" id="voice-female" role="radio" aria-checked="true">
                        Female voice
                    </button>
                    <button class="ff-voice-btn" id="voice-male" role="radio" aria-checked="false">
                        Male voice
                    </button>
                </div>
                <button class="ff-btn--tts" id="tts-btn" aria-label="Read explanation aloud">
                    üîä Read Aloud
                </button>
                <span class="ff-tts-status" id="tts-status" aria-live="polite"></span>
            </div>

        </div><!-- close #diff-content -->
    </div>

    <script>
        // ‚îÄ‚îÄ State ‚îÄ‚îÄ
        let currentData = null;
        let ttsAudio = null;
        let isSpeaking = false;
        let selectedVoice = 'female';

        // ‚îÄ‚îÄ VS Code API ‚îÄ‚îÄ
        let vscode;
        try {
            vscode = acquireVsCodeApi();
            window.vscode = vscode;
        } catch (e) {
            // Browser preview mode ‚Äî no VS Code API
        }

        // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
        function $(id) { return document.getElementById(id); }

        function announce(msg) {
            const el = $('status-live');
            if (el) el.textContent = msg;
        }

        function showSection(id, hasData) {
            const el = $(id);
            if (el) el.style.display = hasData ? '' : 'none';
        }

        function stripHtml(str) {
            if (!str) return '';
            return str.replace(/<[^>]*>/g, '')
                .replace(/&amp;/g, '&').replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>').replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'").replace(/\s+/g, ' ').trim();
        }

        function updateTtsStatus(text) {
            $('tts-status').textContent = text;
        }

        // ‚îÄ‚îÄ Disclosure hint toggle ‚îÄ‚îÄ
        document.querySelectorAll('.ff-disclosure').forEach(function (details) {
            details.addEventListener('toggle', function () {
                var hint = details.querySelector('.ff-disclosure-hint');
                if (!hint) return;
                // Determine default hint text based on the section
                var isQuestion = details.closest('#section-question');
                var showText = isQuestion ? 'Show question' : 'Show details';
                var hideText = isQuestion ? 'Hide question' : 'Hide details';
                hint.textContent = details.open ? hideText : showText;
            });
        });

        // ‚îÄ‚îÄ Update Panel ‚îÄ‚îÄ
        function updatePanel(data) {
            currentData = data;

            // File bar
            const fileName = data.fileName || (data.diff && data.diff.file) || '';
            if (fileName) {
                $('diff-file').textContent = fileName;
                $('file-bar').style.display = '';
            } else {
                $('file-bar').style.display = 'none';
            }

            // 1. Quick Summary
            const hasSummary = !!data.quickSummary;
            showSection('section-summary', hasSummary);
            if (hasSummary) $('quick-summary').textContent = data.quickSummary;

            // 2. Why This Fixes It
            const hasWhy = !!data.whyItWorks;
            showSection('section-why', hasWhy);
            if (hasWhy) $('why-it-works').textContent = data.whyItWorks;

            // 3. What To Do Next (interactive checklist)
            const hasTodo = Array.isArray(data.whatToDoNext) && data.whatToDoNext.length > 0;
            showSection('section-todo', hasTodo);
            const todoList = $('what-to-do-next');
            todoList.innerHTML = '';
            $('check-done').style.display = 'none';
            if (hasTodo) {
                data.whatToDoNext.forEach(function (step, i) {
                    const li = document.createElement('li');
                    li.className = 'ff-check-item';

                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.id = 'todo-' + i;
                    cb.className = 'ff-checkbox';
                    cb.setAttribute('aria-label', step);
                    cb.addEventListener('change', onChecklistChange);

                    const label = document.createElement('label');
                    label.htmlFor = 'todo-' + i;
                    label.className = 'ff-check-label';
                    label.textContent = step;

                    li.appendChild(cb);
                    li.appendChild(label);
                    todoList.appendChild(li);
                });
            }

            // 4. Key Takeaway
            const hasTakeaway = !!data.keyTakeaway;
            showSection('section-takeaway', hasTakeaway);
            if (hasTakeaway) $('key-takeaway').textContent = data.keyTakeaway;

            // 5. Check Question
            const hasQuestion = !!data.checkQuestion;
            showSection('section-question', hasQuestion);
            if (hasQuestion) $('check-question').textContent = data.checkQuestion;

            // Show content, hide empty state
            $('empty-state').style.display = 'none';
            $('diff-content').style.display = '';
            $('tts-controls').style.display = '';
            updateTtsStatus('');

            announce('Fix explanation updated.');
        }

        // ‚îÄ‚îÄ Checklist logic ‚îÄ‚îÄ
        function onChecklistChange() {
            const boxes = document.querySelectorAll('.ff-checkbox');
            const allChecked = Array.from(boxes).every(function (cb) { return cb.checked; });
            $('check-done').style.display = allChecked ? '' : 'none';
            if (allChecked) announce('All steps complete. Nice work!');
        }

        // ‚îÄ‚îÄ TTS helpers ‚îÄ‚îÄ
        function getReadableText() {
            if (!currentData) return '';
            var parts = [];
            if (currentData.quickSummary) parts.push(currentData.quickSummary);
            if (currentData.whyItWorks) parts.push(currentData.whyItWorks);
            if (currentData.keyTakeaway) parts.push('Key takeaway: ' + currentData.keyTakeaway);
            return stripHtml(parts.join('. '));
        }

        function stopAudio() {
            if (ttsAudio) { ttsAudio.pause(); ttsAudio = null; }
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            isSpeaking = false;
            updateTtsStatus('');
        }

        function speakWithWebSpeech(text) {
            if (!('speechSynthesis' in window) || !text) {
                announce('Text-to-speech is not available.');
                updateTtsStatus('');
                return;
            }
            var u = new SpeechSynthesisUtterance(text);
            u.rate = 0.95;
            isSpeaking = true;
            $('tts-btn').textContent = '‚èπÔ∏è Stop';
            $('tts-btn').classList.add('ff-btn--playing');
            updateTtsStatus('Playing...');
            u.onend = function () {
                isSpeaking = false;
                $('tts-btn').textContent = 'üîä Read Aloud';
                $('tts-btn').classList.remove('ff-btn--playing');
                updateTtsStatus('');
            };
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
        }

        // ‚îÄ‚îÄ Voice toggle ‚îÄ‚îÄ
        $('voice-female').addEventListener('click', function () {
            selectedVoice = 'female';
            $('voice-female').classList.add('active');
            $('voice-female').setAttribute('aria-checked', 'true');
            $('voice-male').classList.remove('active');
            $('voice-male').setAttribute('aria-checked', 'false');
        });

        $('voice-male').addEventListener('click', function () {
            selectedVoice = 'male';
            $('voice-male').classList.add('active');
            $('voice-male').setAttribute('aria-checked', 'true');
            $('voice-female').classList.remove('active');
            $('voice-female').setAttribute('aria-checked', 'false');
        });

        // ‚îÄ‚îÄ TTS button ‚îÄ‚îÄ
        $('tts-btn').addEventListener('click', function () {
            if (isSpeaking) {
                stopAudio();
                $('tts-btn').textContent = 'üîä Read Aloud';
                $('tts-btn').classList.remove('ff-btn--playing');
                updateTtsStatus('');
                return;
            }
            var text = getReadableText();
            if (!text) { announce('No explanation to read yet.'); return; }

            if (vscode) {
                vscode.postMessage({ type: 'requestTts', text: text });
                $('tts-btn').textContent = '‚è≥ Loading...';
                updateTtsStatus('Loading...');
            } else {
                speakWithWebSpeech(text);
            }
        });

        // ‚îÄ‚îÄ Listen for messages from extension host ‚îÄ‚îÄ
        window.addEventListener('message', function (event) {
            var msg = event.data;

            if (msg.type === 'showDiff') {
                stopAudio();
                updatePanel(msg.data);

            } else if (msg.type === 'playAudio') {
                stopAudio();
                var audio = new Audio('data:' + msg.data.mimeType + ';base64,' + msg.data.base64Audio);
                ttsAudio = audio;
                isSpeaking = true;
                $('tts-btn').textContent = '‚èπÔ∏è Stop';
                $('tts-btn').classList.add('ff-btn--playing');
                updateTtsStatus('Playing...');
                audio.onended = function () {
                    ttsAudio = null; isSpeaking = false;
                    $('tts-btn').textContent = 'üîä Read Aloud';
                    $('tts-btn').classList.remove('ff-btn--playing');
                    updateTtsStatus('');
                    announce('Audio finished.');
                };
                audio.onerror = function () {
                    ttsAudio = null; isSpeaking = false;
                    $('tts-btn').textContent = 'üîä Read Aloud';
                    $('tts-btn').classList.remove('ff-btn--playing');
                    updateTtsStatus('');
                    announce('Audio playback failed.');
                };
                audio.play().catch(function () {
                    ttsAudio = null; isSpeaking = false;
                    $('tts-btn').textContent = 'üîä Read Aloud';
                    updateTtsStatus('');
                    announce('Could not play audio.');
                });

            } else if (msg.type === 'ttsError') {
                announce(msg.data.message);
                updateTtsStatus('Using browser voice...');
                speakWithWebSpeech(getReadableText());

            } else if (msg.type === 'clear') {
                stopAudio();
                $('empty-state').style.display = '';
                $('diff-content').style.display = 'none';
            }
        });

        // ‚îÄ‚îÄ Init: Mock data for browser preview ‚îÄ‚îÄ
        var MOCK_DATA = {
            fileName: "App.tsx",
            quickSummary: "useState now starts with an empty array. A safety check was added before .map().",
            whyItWorks: "Before, data had no starting value. That made it undefined. You can't call .map() on undefined. Now data starts as [], so .map() always has a list to work with.",
            whatToDoNext: [
                "Confirm useState([]) has square brackets inside.",
                "Look for other useState() calls that may need a starting value.",
                "Run the app and verify the TypeError is gone."
            ],
            keyTakeaway: "Always give useState a starting value that matches how you use it.",
            checkQuestion: "What happens if you call .map() on something that is undefined?"
        };

        if (!vscode) {
            updatePanel(MOCK_DATA);
        } else {
            vscode.postMessage({ type: 'ready' });
        }
    </script>
</body>

</html>
