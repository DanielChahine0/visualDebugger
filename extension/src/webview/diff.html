<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Fix Review ‚Äî Visual Debugger</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="config.js"></script>
    <!-- diff2html CSS (CDN for browser preview; will be bundled by esbuild later) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.48/bundles/css/diff2html.min.css" />
    <style>
        /* diff2html theme overrides for VS Code compatibility */
        .d2h-wrapper {
            background: transparent !important;
            border-radius: 6px;
            overflow: hidden;
        }

        .d2h-file-header {
            background: var(--vscode-editorGroupHeader-tabsBackground, #252526) !important;
            color: var(--vscode-foreground) !important;
            border-bottom: 1px solid var(--vscode-widget-border, rgba(127, 127, 127, 0.2)) !important;
        }

        .d2h-file-wrapper {
            border: 1px solid var(--vscode-widget-border, rgba(127, 127, 127, 0.2)) !important;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .d2h-code-linenumber,
        .d2h-code-line-ctn {
            font-family: var(--vscode-editor-font-family, 'Consolas', monospace) !important;
            font-size: var(--vscode-editor-font-size, 13px) !important;
        }

        /* Green for additions */
        .d2h-ins {
            background: rgba(76, 175, 80, 0.15) !important;
        }

        .d2h-ins .d2h-code-line-ctn {
            background: rgba(76, 175, 80, 0.08) !important;
        }

        /* Red for deletions */
        .d2h-del {
            background: rgba(255, 85, 85, 0.15) !important;
        }

        .d2h-del .d2h-code-line-ctn {
            background: rgba(255, 85, 85, 0.08) !important;
        }
    </style>
</head>

<body>
    <div id="diff-panel">
        <!-- Header -->
        <div class="card-header">
            <h1>üìù AI Fix Review</h1>
        </div>

        <!-- Diff Render Container -->
        <div class="card slide-in" id="diff-container">
            <div class="card-header">
                <span class="badge badge--runtime" id="diff-category-badge">Runtime Error</span>
                <span class="text-muted text-sm" id="diff-file">App.tsx</span>
            </div>
            <div id="diff-output">
                <!-- diff2html renders here -->
            </div>
        </div>

        <!-- AI Explanation Card ("Why It Broke") -->
        <div class="card slide-in diff-explanation" id="explanation-card">
            <div class="section">
                <div class="section-title"><span class="icon">ü§ñ</span> What the AI Changed</div>
                <div class="section-content" id="what-changed">
                    The AI added a null check on line 15 before calling <code>.map()</code> and initialized the
                    <code>data</code> state with an empty array <code>[]</code> instead of leaving it as
                    <code>undefined</code>.
                </div>
            </div>

            <div class="section mt-12">
                <div class="section-title"><span class="icon">üéØ</span> Why This Fixes It</div>
                <div class="section-content" id="why-fixes">
                    The original code assumed <code>data</code> was always an array, but before the API response
                    arrives, <code>data</code> is <code>undefined</code>.
                    By initializing it as <code>[]</code>, <code>.map()</code> now has a valid (empty) array to iterate
                    over. The optional chaining (<code>data?.map()</code>) adds an extra safety net.
                </div>
            </div>

            <div class="section mt-12">
                <div class="section-title"><span class="icon">üí°</span> Key Takeaway</div>
                <div class="section-content" id="key-takeaway" style="font-weight: 500; font-style: italic;">
                    Always initialize state with a default value that matches the expected type ‚Äî arrays as
                    <code>[]</code>, objects as <code>{}</code>, strings as <code>""</code>.
                </div>
            </div>
        </div>

        <!-- TTS Controls -->
        <div class="mt-12" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
            <div
                style="display: flex; border-radius: 6px; overflow: hidden; border: 1px solid var(--vscode-input-border, rgba(127,127,127,0.25));">
                <button class="btn voice-toggle active" id="voice-female"
                    style="border-radius: 0; border: none; padding: 6px 12px; font-size: 0.88em;">üë© Female</button>
                <button class="btn voice-toggle" id="voice-male"
                    style="border-radius: 0; border: none; border-left: 1px solid var(--vscode-input-border, rgba(127,127,127,0.25)); padding: 6px 12px; font-size: 0.88em;">üë®
                    Male</button>
            </div>
            <button class="btn btn--secondary" id="tts-btn">üîä Read Aloud</button>
        </div>
    </div>

    <!-- diff2html JS (CDN for browser preview) -->
    <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.48/bundles/js/diff2html.min.js"></script>
    <script>
        // ‚îÄ‚îÄ State ‚îÄ‚îÄ
        let currentDiffData = null;

        // ‚îÄ‚îÄ VS Code Integration ‚îÄ‚îÄ
        let vscode;
        try {
            vscode = acquireVsCodeApi();
            window.vscode = vscode;
        } catch (e) {
            console.log("Browser preview mode (no VS Code API)");
        }

        // Listen for messages from extension
        window.addEventListener('message', (event) => {
            const { type, data } = event.data; // Extension sends { type: 'showDiff', data: {...} }
            if (type === 'showDiff') {
                updatePanel(data);
            }
        });

        // ‚îÄ‚îÄ Main Update Function ‚îÄ‚îÄ
        function updatePanel(data) {
            currentDiffData = data;

            // Render Diff
            renderDiff(data.unifiedDiff);

            // Render Text Content
            document.getElementById('diff-category-badge').textContent = data.category;
            // Handle badge color mapping if needed, similar to error.html
            document.getElementById('diff-file').textContent = data.fileName;
            document.getElementById('what-changed').innerHTML = data.whatChanged;
            document.getElementById('why-fixes').innerHTML = data.whyItFixes;
            document.getElementById('key-takeaway').innerHTML = data.keyTakeaway;
            
            // Show content
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('diff-content').style.display = 'block';
        }

        // ‚îÄ‚îÄ Render diff using diff2html ‚îÄ‚îÄ
        function renderDiff(diffString) {
            const diffOutput = document.getElementById('diff-output');
            if (typeof Diff2Html !== 'undefined') {
                diffOutput.innerHTML = Diff2Html.html(diffString, {
                    drawFileList: false,
                    matching: 'lines',
                    outputFormat: 'side-by-side',
                    renderNothingWhenEmpty: false
                });
            } else {
                // Fallback: show raw diff in a pre tag
                diffOutput.innerHTML = '<pre style="padding: 12px; overflow-x: auto;"><code>' +
                    diffString.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre>';
            }
        }

        // ‚îÄ‚îÄ Initialization ‚îÄ‚îÄ
        const MOCK_DIFF_DATA = {
            category: "Runtime Error",
            fileName: "App.tsx",
            unifiedDiff: `--- a/src/App.tsx
+++ b/src/App.tsx
@@ -12,8 +12,8 @@
 import { useState, useEffect } from 'react';
 
 function App() {
-  const [data, setData] = useState();
+  const [data, setData] = useState([]);
 
   useEffect(() => {
     fetch('/api/items')
@@ -22,7 +22,7 @@
   }, []);
 
   return (
-    <ul>{data.map(item => (
+    <ul>{data?.map(item => (
       <li key={item.id}>{item.name}</li>
     ))}</ul>
   );`,
            whatChanged: "The AI added a null check on line 15 before calling .map() and initialized the data state with an empty array [] instead of leaving it as undefined.",
            whyItFixes: "The original code assumed 'data' was always an array, but before the API response arrives, 'data' is undefined. By initializing it as [], .map() now has a valid (empty) array to iterate over. The optional chaining (data?.map()) adds an extra safety net.",
            keyTakeaway: "Always initialize state with a default value that matches the expected type ‚Äî arrays as [], objects as {}, strings as ''."
        };

        // If in browser (no vscode), load mock data immediately for preview
        if (!vscode) {
            updatePanel(MOCK_DIFF_DATA);
        }

        // ‚îÄ‚îÄ ElevenLabs TTS ‚Äî Fine-Tuned Natural Voice ‚îÄ‚îÄ
        // Premium voices: Sarah (soft, natural female), Chris (casual, conversational male)
        const VOICES = {
            female: { id: 'EXAVITQu4vr4xnSDxMaL', name: 'Sarah' },
            male: { id: 'iP95p4xoKVk53GoZ742B', name: 'Chris' }
        };
        let selectedVoice = 'female';

        const voiceFemaleBtn = document.getElementById('voice-female');
        const voiceMaleBtn = document.getElementById('voice-male');

        voiceFemaleBtn.addEventListener('click', () => {
            selectedVoice = 'female';
            voiceFemaleBtn.classList.add('active');
            voiceMaleBtn.classList.remove('active');
        });
        voiceMaleBtn.addEventListener('click', () => {
            selectedVoice = 'male';
            voiceMaleBtn.classList.add('active');
            voiceFemaleBtn.classList.remove('active');
        });

        // Strip HTML tags and clean text for natural TTS reading
        function cleanTextForTTS(html) {
            if (!html) return '';
            return html
                .replace(/<code>/g, '')
                .replace(/<\/code>/g, '')
                .replace(/<strong>/g, '')
                .replace(/<\/strong>/g, '')
                .replace(/<em>/g, '')
                .replace(/<\/em>/g, '')
                .replace(/<[^>]*>/g, '')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/\s+/g, ' ')
                .trim();
        }

        const ttsBtn = document.getElementById('tts-btn');
        let ttsAudio = null;
        let isSpeaking = false;

        ttsBtn.addEventListener('click', async () => {
            if (isSpeaking && ttsAudio) {
                ttsAudio.pause(); ttsAudio = null; isSpeaking = false;
                ttsBtn.textContent = 'üîä Read Aloud';
                ttsBtn.classList.remove('btn--tts-playing');
                return;
            }
            
            const data = currentDiffData || MOCK_DIFF_DATA;
            const textToRead = cleanTextForTTS(
                data.whatChanged + '. ' + data.whyItFixes + '. Key takeaway: ' + data.keyTakeaway
            );
            
            const apiKey = (typeof ELEVENLABS_API_KEY !== 'undefined' && ELEVENLABS_API_KEY !== 'your_api_key_here')
                ? ELEVENLABS_API_KEY : null;
            ttsBtn.textContent = '‚è≥ Loading...';
            ttsBtn.classList.add('btn--tts-loading');
            if (apiKey) {
                try {
                    const voice = VOICES[selectedVoice];
                    const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'xi-api-key': apiKey },
                        body: JSON.stringify({
                            text: textToRead,
                            model_id: 'eleven_turbo_v2_5',
                            voice_settings: {
                                stability: 0.50,
                                similarity_boost: 0.65,
                                style: 0.10,
                                use_speaker_boost: true
                            }
                        })
                    });
                    if (!res.ok) {
                        const errorBody = await res.text().catch(() => '');
                        throw new Error(`API ${res.status}: ${errorBody.slice(0, 100)}`);
                    }
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    ttsAudio = new Audio(url);
                    isSpeaking = true;
                    ttsBtn.textContent = '‚èπÔ∏è Stop';
                    ttsBtn.classList.remove('btn--tts-loading');
                    ttsBtn.classList.add('btn--tts-playing');
                    ttsAudio.onended = () => {
                        isSpeaking = false;
                        ttsBtn.textContent = 'üîä Read Aloud';
                        ttsBtn.classList.remove('btn--tts-playing');
                        URL.revokeObjectURL(url);
                    };
                    ttsAudio.onerror = () => {
                        isSpeaking = false;
                        ttsBtn.textContent = '‚ùå Audio Error';
                        ttsBtn.classList.remove('btn--tts-playing');
                        setTimeout(() => { ttsBtn.textContent = 'üîä Read Aloud'; }, 3000);
                    };
                    ttsAudio.play();
                    return;
                } catch (e) {
                    console.warn('ElevenLabs TTS error:', e);
                    ttsBtn.textContent = '‚ùå ' + (e.message || 'TTS Failed');
                    ttsBtn.classList.remove('btn--tts-loading');
                    setTimeout(() => { ttsBtn.textContent = 'üîä Read Aloud'; }, 3000);
                }
            }
            ttsBtn.classList.remove('btn--tts-loading');
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(textToRead);
                u.rate = 0.95;
                u.pitch = 1.0;
                isSpeaking = true;
                ttsBtn.textContent = '‚èπÔ∏è Stop';
                ttsBtn.classList.add('btn--tts-playing');
                u.onend = () => { isSpeaking = false; ttsBtn.textContent = 'üîä Read Aloud'; ttsBtn.classList.remove('btn--tts-playing'); };
                speechSynthesis.speak(u);
            } else {
                ttsBtn.textContent = '‚ùå TTS Unavailable';
                setTimeout(() => { ttsBtn.textContent = 'üîä Read Aloud'; }, 3000);
            }
        });
    </script>
</body>

</html>