<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Fix Review ‚Äî Visual Debugger</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="config.js"></script>
    <!-- diff2html CSS (CDN for browser preview; will be bundled by esbuild later) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.48/bundles/css/diff2html.min.css" />
    <style>
        /* diff2html theme overrides for VS Code compatibility */
        .d2h-wrapper {
            background: transparent !important;
            border-radius: 6px;
            overflow: hidden;
        }

        .d2h-file-header {
            background: var(--vscode-editorGroupHeader-tabsBackground, #252526) !important;
            color: var(--vscode-foreground) !important;
            border-bottom: 1px solid var(--vscode-widget-border, rgba(127, 127, 127, 0.2)) !important;
        }

        .d2h-file-wrapper {
            border: 1px solid var(--vscode-widget-border, rgba(127, 127, 127, 0.2)) !important;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .d2h-code-linenumber,
        .d2h-code-line-ctn {
            font-family: var(--vscode-editor-font-family, 'Consolas', monospace) !important;
            font-size: var(--vscode-editor-font-size, 13px) !important;
        }

        /* Green for additions */
        .d2h-ins {
            background: rgba(76, 175, 80, 0.15) !important;
        }

        .d2h-ins .d2h-code-line-ctn {
            background: rgba(76, 175, 80, 0.08) !important;
        }

        /* Red for deletions */
        .d2h-del {
            background: rgba(255, 85, 85, 0.15) !important;
        }

        .d2h-del .d2h-code-line-ctn {
            background: rgba(255, 85, 85, 0.08) !important;
        }
    </style>
</head>

<body>
    <div id="diff-panel">
        <!-- Header -->
        <div class="card-header">
            <h1>üìù AI Fix Review</h1>
        </div>

        <!-- Empty state ‚Äî shown before any diff is detected -->
        <div id="empty-state" class="card" style="text-align: center; padding: 32px 16px; opacity: 0.7;">
            <p style="font-size: 1.1em; margin-bottom: 8px;">No AI fixes to review yet.</p>
            <p class="text-muted text-sm">After an error is detected, use an AI tool (Copilot, Cursor, etc.) to fix it. Visual Debugger will explain the changes.</p>
        </div>

        <!-- Diff content ‚Äî hidden until a diff is received -->
        <div id="diff-content" style="display: none;">

        <!-- Diff Render Container -->
        <div class="card slide-in" id="diff-container">
            <div class="card-header">
                <span class="badge" id="diff-category-badge"></span>
                <span class="text-muted text-sm" id="diff-file"></span>
            </div>
            <div id="diff-output">
                <!-- diff2html renders here -->
            </div>
        </div>

        <!-- AI Explanation Card -->
        <div class="card slide-in diff-explanation" id="explanation-card">
            <div class="section">
                <div class="section-title"><span class="icon">ü§ñ</span> Quick Summary</div>
                <div class="section-content" id="quick-summary"></div>
            </div>

            <div class="section mt-12">
                <div class="section-title"><span class="icon">üéØ</span> Why It Works</div>
                <div class="section-content" id="why-it-works"></div>
            </div>

            <div class="section mt-12">
                <div class="section-title"><span class="icon">üìã</span> What To Do Next</div>
                <ol class="section-content" id="what-to-do-next" style="padding-left: 20px; margin: 0;"></ol>
            </div>

            <div class="section mt-12">
                <div class="section-title"><span class="icon">üí°</span> Key Takeaway</div>
                <div class="section-content" id="key-takeaway" style="font-weight: 500; font-style: italic;"></div>
            </div>

            <div class="section mt-12">
                <div class="section-title"><span class="icon">‚ùì</span> Check Your Understanding</div>
                <div class="section-content" id="check-question" style="font-weight: 500;"></div>
            </div>
        </div>

        </div><!-- close #diff-content -->

        <!-- TTS Controls -->
        <div class="mt-12" id="tts-controls" style="display: none; align-items: center; gap: 10px; flex-wrap: wrap;">
            <div
                style="display: flex; border-radius: 6px; overflow: hidden; border: 1px solid var(--vscode-input-border, rgba(127,127,127,0.25));">
                <button class="btn voice-toggle active" id="voice-female"
                    style="border-radius: 0; border: none; padding: 6px 12px; font-size: 0.88em;">üë© Female</button>
                <button class="btn voice-toggle" id="voice-male"
                    style="border-radius: 0; border: none; border-left: 1px solid var(--vscode-input-border, rgba(127,127,127,0.25)); padding: 6px 12px; font-size: 0.88em;">üë®
                    Male</button>
            </div>
            <button class="btn btn--secondary" id="tts-btn">üîä Read Aloud</button>
        </div>
    </div>

    <!-- diff2html JS (CDN for browser preview) -->
    <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.48/bundles/js/diff2html.min.js"></script>
    <script>
        // ‚îÄ‚îÄ State ‚îÄ‚îÄ
        let currentDiffData = null;

        // ‚îÄ‚îÄ VS Code Integration ‚îÄ‚îÄ
        let vscode;
        try {
            vscode = acquireVsCodeApi();
            window.vscode = vscode;
        } catch (e) {
            console.log("Browser preview mode (no VS Code API)");
        }

        // Listen for messages from extension
        window.addEventListener('message', (event) => {
            const { type, data } = event.data; // Extension sends { type: 'showDiff', data: {...} }
            if (type === 'showDiff') {
                updatePanel(data);
            }
        });

        // ‚îÄ‚îÄ Main Update Function ‚îÄ‚îÄ
        function updatePanel(data) {
            currentDiffData = data;

            // Diff data may be at top level (mock) or nested under data.diff (real)
            const diffStr = data.unifiedDiff || (data.diff && data.diff.unifiedDiff) || '';
            const fileName = data.fileName || (data.diff && data.diff.file) || '';
            const category = data.category || '';

            // Render Diff
            renderDiff(diffStr);

            // Render Text Content
            if (category) {
                document.getElementById('diff-category-badge').textContent = category;
            }
            document.getElementById('diff-file').textContent = fileName;
            document.getElementById('quick-summary').innerHTML = data.quickSummary || '';
            document.getElementById('why-it-works').innerHTML = data.whyItWorks || '';

            // Render whatToDoNext as ordered list items
            const todoList = document.getElementById('what-to-do-next');
            todoList.innerHTML = '';
            if (Array.isArray(data.whatToDoNext)) {
                data.whatToDoNext.forEach(step => {
                    const li = document.createElement('li');
                    li.textContent = step;
                    li.style.marginBottom = '4px';
                    todoList.appendChild(li);
                });
            }

            document.getElementById('key-takeaway').innerHTML = data.keyTakeaway || '';
            document.getElementById('check-question').innerHTML = data.checkQuestion || '';

            // Show content, hide empty state
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('diff-content').style.display = 'block';
            document.getElementById('tts-controls').style.display = 'flex';
        }

        // ‚îÄ‚îÄ Render diff using diff2html ‚îÄ‚îÄ
        function renderDiff(diffString) {
            const diffOutput = document.getElementById('diff-output');
            if (typeof Diff2Html !== 'undefined') {
                diffOutput.innerHTML = Diff2Html.html(diffString, {
                    drawFileList: false,
                    matching: 'lines',
                    outputFormat: 'side-by-side',
                    renderNothingWhenEmpty: false
                });
            } else {
                // Fallback: show raw diff in a pre tag
                diffOutput.innerHTML = '<pre style="padding: 12px; overflow-x: auto;"><code>' +
                    diffString.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre>';
            }
        }

        // ‚îÄ‚îÄ Initialization ‚îÄ‚îÄ
        const MOCK_DIFF_DATA = {
            category: "Runtime Error",
            fileName: "App.tsx",
            unifiedDiff: `--- a/src/App.tsx
+++ b/src/App.tsx
@@ -12,8 +12,8 @@
 import { useState, useEffect } from 'react';

 function App() {
-  const [data, setData] = useState();
+  const [data, setData] = useState([]);

   useEffect(() => {
     fetch('/api/items')
@@ -22,7 +22,7 @@
   }, []);

   return (
-    <ul>{data.map(item => (
+    <ul>{data?.map(item => (
       <li key={item.id}>{item.name}</li>
     ))}</ul>
   );`,
            quickSummary: "useState now starts with an empty array. A safety check was added before .map().",
            whyItWorks: "Before, data had no starting value. That made it undefined. You can't call .map() on undefined. Now data starts as [], so .map() always has a list to work with.",
            whatToDoNext: ["Confirm useState([]) has square brackets inside.", "Look for other useState() calls that may need a starting value.", "Run the app and verify the TypeError is gone."],
            keyTakeaway: "Always give useState a starting value that matches how you use it.",
            checkQuestion: "What happens if you call .map() on something that is undefined?"
        };

        // If in browser (no vscode), load mock data immediately for preview
        if (!vscode) {
            updatePanel(MOCK_DIFF_DATA);
        } else {
            // Signal that the webview is ready to receive messages
            vscode.postMessage({ type: 'ready' });
        }

        // ‚îÄ‚îÄ ElevenLabs TTS ‚Äî Fine-Tuned Natural Voice ‚îÄ‚îÄ
        // Premium voices: Sarah (soft, natural female), Chris (casual, conversational male)
        const VOICES = {
            female: { id: 'EXAVITQu4vr4xnSDxMaL', name: 'Sarah' },
            male: { id: 'iP95p4xoKVk53GoZ742B', name: 'Chris' }
        };
        let selectedVoice = 'female';

        const voiceFemaleBtn = document.getElementById('voice-female');
        const voiceMaleBtn = document.getElementById('voice-male');

        voiceFemaleBtn.addEventListener('click', () => {
            selectedVoice = 'female';
            voiceFemaleBtn.classList.add('active');
            voiceMaleBtn.classList.remove('active');
        });
        voiceMaleBtn.addEventListener('click', () => {
            selectedVoice = 'male';
            voiceMaleBtn.classList.add('active');
            voiceFemaleBtn.classList.remove('active');
        });

        // Strip HTML tags and clean text for natural TTS reading
        function cleanTextForTTS(html) {
            if (!html) return '';
            return html
                .replace(/<code>/g, '')
                .replace(/<\/code>/g, '')
                .replace(/<strong>/g, '')
                .replace(/<\/strong>/g, '')
                .replace(/<em>/g, '')
                .replace(/<\/em>/g, '')
                .replace(/<[^>]*>/g, '')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/\s+/g, ' ')
                .trim();
        }

        const ttsBtn = document.getElementById('tts-btn');
        let ttsAudio = null;
        let isSpeaking = false;

        ttsBtn.addEventListener('click', async () => {
            if (isSpeaking && ttsAudio) {
                ttsAudio.pause(); ttsAudio = null; isSpeaking = false;
                ttsBtn.textContent = 'üîä Read Aloud';
                ttsBtn.classList.remove('btn--tts-playing');
                return;
            }
            
            const data = currentDiffData || MOCK_DIFF_DATA;
            const textToRead = cleanTextForTTS(
                data.quickSummary + '. ' + data.whyItWorks + '. Key takeaway: ' + data.keyTakeaway
            );
            
            const apiKey = (typeof ELEVENLABS_API_KEY !== 'undefined' && ELEVENLABS_API_KEY !== 'your_api_key_here')
                ? ELEVENLABS_API_KEY : null;
            ttsBtn.textContent = '‚è≥ Loading...';
            ttsBtn.classList.add('btn--tts-loading');
            if (apiKey) {
                try {
                    const voice = VOICES[selectedVoice];
                    const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'xi-api-key': apiKey },
                        body: JSON.stringify({
                            text: textToRead,
                            model_id: 'eleven_turbo_v2_5',
                            voice_settings: {
                                stability: 0.50,
                                similarity_boost: 0.65,
                                style: 0.10,
                                use_speaker_boost: true
                            }
                        })
                    });
                    if (!res.ok) {
                        const errorBody = await res.text().catch(() => '');
                        throw new Error(`API ${res.status}: ${errorBody.slice(0, 100)}`);
                    }
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    ttsAudio = new Audio(url);
                    isSpeaking = true;
                    ttsBtn.textContent = '‚èπÔ∏è Stop';
                    ttsBtn.classList.remove('btn--tts-loading');
                    ttsBtn.classList.add('btn--tts-playing');
                    ttsAudio.onended = () => {
                        isSpeaking = false;
                        ttsBtn.textContent = 'üîä Read Aloud';
                        ttsBtn.classList.remove('btn--tts-playing');
                        URL.revokeObjectURL(url);
                    };
                    ttsAudio.onerror = () => {
                        isSpeaking = false;
                        ttsBtn.textContent = '‚ùå Audio Error';
                        ttsBtn.classList.remove('btn--tts-playing');
                        setTimeout(() => { ttsBtn.textContent = 'üîä Read Aloud'; }, 3000);
                    };
                    ttsAudio.play();
                    return;
                } catch (e) {
                    console.warn('ElevenLabs TTS error:', e);
                    ttsBtn.textContent = '‚ùå ' + (e.message || 'TTS Failed');
                    ttsBtn.classList.remove('btn--tts-loading');
                    setTimeout(() => { ttsBtn.textContent = 'üîä Read Aloud'; }, 3000);
                }
            }
            ttsBtn.classList.remove('btn--tts-loading');
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(textToRead);
                u.rate = 0.95;
                u.pitch = 1.0;
                isSpeaking = true;
                ttsBtn.textContent = '‚èπÔ∏è Stop';
                ttsBtn.classList.add('btn--tts-playing');
                u.onend = () => { isSpeaking = false; ttsBtn.textContent = 'üîä Read Aloud'; ttsBtn.classList.remove('btn--tts-playing'); };
                speechSynthesis.speak(u);
            } else {
                ttsBtn.textContent = '‚ùå TTS Unavailable';
                setTimeout(() => { ttsBtn.textContent = 'üîä Read Aloud'; }, 3000);
            }
        });
    </script>
</body>

</html>